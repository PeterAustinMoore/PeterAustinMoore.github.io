<html>
<head>
    <!--SCRIPTS-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
	<script src="https://fb.me/react-with-addons-0.13.3.js"></script>
	<script src="https://fb.me/JSXTransformer-0.13.3.js"></script>
    <!--STYLES-->
    <style>
    html, body {
    	margin:0;
    	width:100%;
    	height:100%;
    	overflow: hidden;
    	padding: 0;
    }
    #header{
    	height:80px;
    	width: 100%;
    }
    .input{
    	margin-top:10px;
    	max-width: 350px;
    	width:200em;
    	height:40%;
    	margin-left:30px;
    	text-align: left;
    	font-size: 80%;
    }
   	.subBtn {
	-webkit-box-shadow:rgba(0,0,0,0.2) 0 1px 0 0;
	-moz-box-shadow:rgba(0,0,0,0.2) 0 1px 0 0;
	box-shadow:rgba(0,0,0,0.2) 0 1px 0 0;
	border-bottom-color:#333;
	border:1px solid #61c4ea;
	background-color:#7cceee;
	border-radius:5px;
	-moz-border-radius:5px;
	-webkit-border-radius:5px;
	color:#333;
	font-family:'Verdana',Arial,sans-serif;
	font-size:14px;
	text-shadow:#b2e2f5 0 1px 0;
	padding:5px;
	margin-left: 20px;
	}
	.subBtn:hover{
		background-color: #D3D3D3;
		cursor: pointer;
	}
    #buttonContainer{
    	height: 60px;
    	width: 100%;
    }
    .chart {

	}

	.main text {
	    font: 10px sans-serif;	
	}

	.axis line, .axis path {
	    shape-rendering: crispEdges;
	    stroke: black;
	    fill: none;
	}
	circle {
	    fill: steelblue;
	}
    </style>
    <!--Custom Scripts-->

</head>
<body>
 <script type="text/jsx">
//Main App Container
var RegressionApp = React.createClass({
  getInitialState: function()
  {
     return ({
     		hostURL: '',
     		datasetId: '',
     		headerData:'',
     		dependent:'',
     		independent:'',
          	jsonData: ''
      })
  },
  render: function() {

    return (
      <div>
        <C1 onUpdate={this.onUpdate} onUpdateT={this.onUpdateT} onHostSubmit={this.onHostSubmit}/>
        <StatOptions data={this.state.headerData} onDataSubmit={this.onDataSubmit} url={this.state.hostURL} dataId={this.state.datasetId} />
        <DoStats data={this.state.jsonData} x={this.state.independent} y={this.state.dependent}/>
      </div>
      )
  },
  onHostSubmit: function(data, URL, id){
  	console.log(data);
  	this.setState({
  		headerData: data,
  		hostURL: URL,
  		datasetId: id
  	});
  },
  onDataSubmit: function(data, dep, ind){
  	this.setState({
  		dependent: dep,
  		independent: ind,
  		jsonData: data
  	});
  }
  
});

var C1 = React.createClass({
    getInitialState: function()
    {
    	return ({
    		jsonData: '',
    		isDataSet: false
    		})
    },
    render: function()
    {
        return (
            <div id="header">
                <input className="input" type="text" ref="DataId" />
                <input className="input" type="text" ref="myInput" value="peter.demo.socrata.com" />           
                <input className="subBtn" type="button" onClick={this.getHeaders} value="Submit"/>
            </div>
        )
    },
    getHeaders: function()
    {
    	var DataId = this.refs.DataId.getDOMNode().value.substr(0,9);
        var DataURL = this.refs.myInput.getDOMNode().value;
        console.log("Data id: " + DataId.toString());
        console.log("Data URL: "+ DataURL.toString());
        $.getJSON("https://"+DataURL+"/resource/"+DataId+"?$limit=2", function(data){
        	console.log(data);
      		this.props.onHostSubmit(data, DataURL, DataId);
        }.bind(this)
        );
    }
});

///GET THE VARIABLES
var StatOptions = React.createClass({
	render: function()
	{
		if(this.props.data)
		{
			var options = [];
			var keys = []
			keys = Object.keys(this.props.data[0]);
			keys.forEach(function(data){
				options.push(<GetOptions data={data} />);
			});
		return(
			<div id="StatOptions">
			<h3>Choose a dependent variable: <select ref="dependent">{options}</select></h3>
			<h3>Choose a independent variable: <select ref="independent">{options}</select></h3>
			<input type="submit" value="Regress" onClick={this.getData}/>
			</div>
			)
		}
		else
		{
			return null;
		}
	},
	getData: function()
    {
    	var dependent = this.refs.dependent.getDOMNode().value;
        var independent = this.refs.independent.getDOMNode().value;

        $.getJSON("https://"+this.props.url+"/resource/"+this.props.dataId+"?$select="+dependent+","+independent, function(data){
        	console.log(data);
      		this.props.onDataSubmit(data, dependent, independent);
        }.bind(this)
        );
    }
});

var	GetOptions = React.createClass({
	render: function()
	{

		return (
			<option value={this.props.data}>{this.props.data}</option>
			);
	}
});
//Get the header rows and populate the drop down menus
var DoStats = React.createClass({
	render: function()
	{
		if(this.props.data)
		{
		return(
		<div>
		<h3>The Count is: {this.getCount(this.props.data)} </h3>
		<h3>The Sum of x values is: {this.getSumX(this.props.data)} </h3>
		<h3>Equation: X </h3>
		<Graphs data={this.props.data} />
		</div>
			
		)
		}
		else
		{
			return(
			<h3>Awaiting Input...</h3>
			)
		}
	},
	getCount: function(data)
	{
		var count = 0;
		$.each(data, function(data){	
			count += 1;
		});
		return count;
	},
	getSumX: function(data)
	{
		var x = this.props.x;
		var sum = 0;
		$.each(data, function(i, data){
			sum += parseInt(data[x]);
		});
		return sum;
	}, 
	getSumY: function(data, y)
	{

	},
	getSumXY: function(data, x, y)
	{

	},
	getSumXX: function(data, x, x)
	{

	},
	getM: function(data, x, y)
	{

	},
	getB: function(data, x, y)
	{

	}

});


//MAKE THE CHART!
var d3Chart = {};

d3Chart.create = function(el, props, state) {
  
			linedata = [
			[0,0],
			[1,1],
			[2,2],
			[4,4],
			[10,10]
			];
			//Width and height
			var w = 500;
			var h = 300;
			var padding = 30;
			
			dataset = [];

			$.each(state.data, function(i){
				var arr = [parseInt(state.data[i].x), parseInt(state.data[i].y)];
				dataset.push(arr);
			});


			
			//Create scale functions
			var xScale = d3.scale.linear()
								 .domain([0, d3.max(dataset, function(d) { return parseInt(d[0]); })])
								 .range([padding, w - padding * 2]);

			var yScale = d3.scale.linear()
								 .domain([0, d3.max(dataset, function(d) { return parseInt(d[1]); })])
								 .range([h - padding, padding]);

			var rScale = d3.scale.linear()
								 .domain([0, d3.max(dataset, function(d) { return parseInt(d[1]); })])
								 .range([2, 5]);



			var xLinScale = d3.scale.linear()
								 .domain([0, d3.max(linedata, function(d) { return d[0]; })])
								 .range([padding, w - padding * 2]);

			var yLinScale = d3.scale.linear()
								 .domain([0, d3.max(linedata, function(d) { return d[1]; })])
								 .range([h - padding, padding]);

		
			//Define Axes
			var xAxis = d3.svg.axis()
							  .scale(xScale)
							  .orient("bottom");
			var yAxis = d3.svg.axis()
            			      .scale(yScale)
                  				.orient("left");

			//Create SVG element
			var svg = d3.select("body")
						.append("svg")
						.attr("width", w)
						.attr("height", h);

			//Create circles
			svg.selectAll("circle")
			   .data(dataset)
			   .enter()
			   .append("circle")
			   .attr("cx", function(d) {
			   		return xScale(parseInt(d[0]));
			   })
			   .attr("cy", function(d) {
			   		return yScale(parseInt(d[1]));
			   })
			   .attr("r", 5);
			   

			var line = d3.svg.line()
						.x(function(d,i){
							return xLinScale(d[0]);
						})
						.y(function(d,i){
							return yLinScale(d[1]);
						})
						.interpolate("linear");
			svg.append('svg:path')
				.attr('d',line(linedata))
				.attr('stroke','black')
				.attr('stroke-width',2)
				.attr('fill','none');
			/*
			svg.selectAll("text")
			   .data(dataset)
			   .enter()
			   .append("text")
			   .text(function(d) {
			   		return d[0] + "," + d[1];
			   })
			   .attr("x", function(d) {
			   		return xScale(d[0]);
			   })
			   .attr("y", function(d) {
			   		return yScale(d[1]);
			   })
			   .attr("font-family", "sans-serif")
			   .attr("font-size", "11px")
			   .attr("fill", "red");
			
			*/
			//Create X axis
			svg.append("g")
				.attr("class", "axis")
				.attr("transform", "translate(0," + (h - padding) + ")")
				.call(xAxis);



            svg.append("g")
    			.attr("class", "axis")
    			.attr("transform", "translate(" + padding + ",0)")
    			.call(yAxis);

};

var Chart = React.createClass({
  propTypes: {
    data: React.PropTypes.array,
    domain: React.PropTypes.object
  },

  componentDidMount: function() {
    var el = React.findDOMNode(this.refs.Chart);
    d3Chart.create(el, {
      width: '300px',
      height: '300px'
    }, this.getChartState());

  },

  getChartState: function() {
    return {
      data: this.props.data,
      domain: this.props.domain
    };
  },

  componentWillUnmount: function() {
    var el = React.findDOMNode(this.refs.Chart);
    d3Chart.destroy(el);
  },

  render: function() {
    return (
      <div className="Chart" id="Chart" ref="Chart"></div>
    );
  }
});


//ACTUALLY DRAW THE CHART
var sampleData = [
				  [ 5,     20 ],
                  [ 80,   90 ],
                  [ 50,   50 ],
                  [ 10,   33 ],
                  [ 30,   95 ],
                  [ 10,   12 ],
                  [ 75,   44 ],
                  [ 25,    67 ],
                  [ 85,    21 ],
                  [ 20,   88 ]
  // ...
];

var Graphs = React.createClass({
  getInitialState: function() {
    return {
      //data: sampleData,
      domain: {x: [0, 100], y: [0, 100]}
    };
  },

  render: function() {
    return (
      <div className="App">
        <Chart
          data={this.props.data}
          domain={this.state.domain} />
      </div>
    );
  }
});

//Call Regression App to Body
React.render(<RegressionApp/>, document.body);
</script>
</body>
</html>